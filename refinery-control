-- Config

DIESEL_25PCT_COLOR = colors.red
DIESEL_80PCT_COLOR = colors.green

KEROSENE_25PCT_COLOR = colors.brown
KEROSENE_80PCT_COLOR = colors.blue

GASOLINE_25PCT_COLOR = colors.purple
GASOLINE_80PCT_COLOR = colors.cyan

LPG_25PCT_COLOR = colors.lightGray
LPG_80PCT_COLOR = colors.gray

CONDUIT_LOCATION = "back"

MODEM_LOCATION = "top"
REFINERY_CHAN = 10
LUBRICANT_CHAN = 20
KEROSENE_CHAN = 22
GASOLINE_CHAN = 24
LPG_CHAN = 26

-- Init
refinery_active = false

diesel_drain_active = false
kerosene_drain_active = false
gasoline_drain_active = false
lpg_drain_active = false

diesel_to_lubricant_active = false
diesel_to_kerosene_active = false
kerosene_to_gasoline_active = false
gasoline_to_lpg_active = false

modem = peripheral.wrap(MODEM_LOCATION)

-- Loop
while true do
  local diesel_crit = not(colors.test(redstone.getBundledInput(CONDUIT_LOCATION), DIESEL_25PCT_COLOR))
  local diesel_full = colors.test(redstone.getBundledInput(CONDUIT_LOCATION), DIESEL_80PCT_COLOR)
  local kerosene_crit = not(colors.test(redstone.getBundledInput(CONDUIT_LOCATION), KEROSENE_25PCT_COLOR))
  local kerosene_full = colors.test(redstone.getBundledInput(CONDUIT_LOCATION), KEROSENE_80PCT_COLOR)
  local gasoline_crit = not(colors.test(redstone.getBundledInput(CONDUIT_LOCATION), GASOLINE_25PCT_COLOR))
  local gasoline_full = colors.test(redstone.getBundledInput(CONDUIT_LOCATION), GASOLINE_80PCT_COLOR)
  local lpg_crit = not(colors.test(redstone.getBundledInput(CONDUIT_LOCATION), LPG_25PCT_COLOR))
  local lpg_full = colors.test(redstone.getBundledInput(CONDUIT_LOCATION), LPG_80PCT_COLOR)

  -- Drain Active: if fluid has stored >80%, then active
  -- if stored fluid is <25%, then disable
  if diesel_drain_active then
    if diesel_crit then
      diesel_drain_active = false
    end
  else
    if diesel_full then
      diesel_drain_active = true
    end
  end
  if kerosene_drain_active then
    if kerosene_crit then
      kerosene_drain_active = false
    end
  else
    if kerosene_full then
      kerosene_drain_active = true
    end
  end
  if gasoline_drain_active then
    if gasoline_crit then
      gasoline_drain_active = false
    end
  else
    if gasoline_full then
      gasoline_drain_active = true
    end
  end
  if lpg_drain_active then
    if lpg_crit then
      lpg_drain_active = false
    end
  else
    if lpg_full then
      lpg_drain_active = true
    end
  end
  
  
  -- Refinery: Active if All of (diesel, kerosene, gasoline, lpg) store is <80%
  -- not affected with drain_active
  refinery_active = (not (diesel_full or kerosene_full or gasoline_full or lpg_full))
  
  -- Below are affected to drain_active of source liquid
  -- Diesel -> Lubricant: Active if Diesel >25%
  diesel_to_lubricant_active = diesel_drain_active
  diesel_to_kerosene_active = diesel_drain_active and (not kerosene_full)
  kerosene_to_gasoline_active = kerosene_drain_active and (not gasoline_full)
  gasoline_to_lpg_active = gasoline_drain_active and (not lpg_full)

  modem.transmit(REFINERY_CHAN, REFINERY_CHAN + 1, refinery_active)
  modem.transmit(LUBRICANT_CHAN, LUBRICANT_CHAN + 1, diesel_to_lubricant_active)
  modem.transmit(KEROSENE_CHAN, KEROSENE_CHAN + 1, diesel_to_kerosene_active)
  modem.transmit(GASOLINE_CHAN, GASOLINE_CHAN + 1, kerosene_to_gasoline_active)
  modem.transmit(LPG_CHAN, LPG_CHAN + 1, gasoline_to_lpg_active)

  os.sleep(10)
end
